<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History by Stores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <!-- Navigation bar -->
    <div class="container mt-2">
        <h1 class="text-center mb-3 bg-dark text-white py-2">Sales History by Stores</h1>
        <div id="sales-history">
            <!--Sales history data will be displayed here--> 
        </div>
    </div>



    <script>
        // Fetch sales history data from the API
        document.addEventListener("DOMContentLoaded", function () {
            axios.get("http://localhost:1337/api/sales-history-by-stores?populate=*")
                .then(response => {
                    const salesData = response.data.data;
                    const salesHistoryContainer = document.getElementById("sales-history");

                    // Create a map to group sales by user
                    const usersMap = new Map();


                    // Iterate over each sale and group them by user
                    salesData.forEach(sale => {
                        const user = sale.users_permissions_users[0];
                        const product = sale.products[0];
                        const userId = user.id;

                        if (!usersMap.has(userId)) {
                            usersMap.set(userId, {
                                userDetails: user,
                                sales: [],
                                productsSummary: new Map()
                            });
                        }

                        // Add sale to user's sales
                        usersMap.get(userId).sales.push({ sale, product });

                    
                        // Create a unique key for each product
                        const productKey = `${product.productName}-${product.brand}`;
                        // Get the user's product summary
                        const productsSummary = usersMap.get(userId).productsSummary;
                        

                        // Update product summary
                        // If the product is already in the summary, increment the quantity
                        if (productsSummary.has(productKey)) {
                            productsSummary.get(productKey).quantity += sale.quantity;
                        } else {
                            productsSummary.set(productKey, {
                                productName: product.productName,
                                brand: product.brand,
                                quantity: sale.quantity
                            });
                        }
                    });

                    // Iterate over each user and display their sales history
                    usersMap.forEach((userData, userId) => {
                        const user = userData.userDetails;
                        const sales = userData.sales;
                        const productsSummary = userData.productsSummary;

                        let totalQuantity = 0;
                        let totalPrice = 0;

                        // Calculate total quantity and total price
                        sales.forEach(({ sale }) => {
                            totalQuantity += sale.quantity;
                            totalPrice += sale.totalPrice;
                        });

                        // Create user card
                        const userCard = document.createElement("div");
                        userCard.className = "mb-3";

                        userCard.innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#user-${userId}" aria-expanded="false">
                                            ${user.username} (${user.email})
                                        </button>
                                    </h5>
                                </div>
                                <div id="user-${userId}" class="collapse">
                                    <div class="card-body">
                                         <h6 class="mt-3">Product Summary:</h6>
                                        <ul>
                                            ${Array.from(productsSummary.values()).map(product => `
                                                <li><strong>${product.productName} (${product.brand})</strong>: ${product.quantity} items sold</li>
                                            `).join('')}
                                        </ul>
                                        <p><strong>Total Quantity Sold:</strong> ${totalQuantity}</p>
                                        <p><strong>Total Sales Value:</strong> ${totalPrice.toFixed(2)} Php</p>


                                        ${sales.map(({ sale, product }) => `
                                            <div class="card mb-2">
                                                <div class="card-body">
                                                    <p class="card-text">
                                                        <strong>Product:</strong> ${product.productName} (${product.type})<br>
                                                        <strong>Brand:</strong> ${product.brand}<br>
                                                        <strong>Quantity:</strong> ${sale.quantity}<br>
                                                        <strong>Price per Unit:</strong> ${product.Price} Php<br>
                                                        <strong>Total Price:</strong> ${sale.totalPrice} Php<br> 
                                                    </p>
                                                    <p class="text-muted">
                                                        <small>Created at: ${new Date(sale.createdAt).toLocaleString()}</small>
                                                    </p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;

                        // Append user card to the sales history container
                        salesHistoryContainer.appendChild(userCard);
                    });
                })
                .catch(error => {
                    console.error("Error fetching sales data:", error);
                });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
