<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales by Stores</title>
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Main container for the page -->
    <div class="container mt-3">
        <h1 class="text-center mb-4 bg-dark text-white py-3">Sales History</h1>
        <!-- List to display sales data -->
        <ul id="salesContainer" class="list-group"></ul>
        <!-- Container to display total sales by item -->
        <div id="totalByItemContainer" class="mt-4"></div>
        <!-- Container to display the total sales amount -->
        <div id="totalSalesContainer" class="mt-4 text-center"></div>
    </div>

    <!-- Bootstrap JS Bundle with Popper for functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wait for the DOM to fully load
        document.addEventListener("DOMContentLoaded", async () => {
            // API URL to fetch sales history data
            const salesApiUrl = 'http://localhost:1337/api/sales-history-by-stores?populate=*';
            // Get auth token and user ID from local storage
            const authToken = localStorage.getItem('authToken');
            const userId = parseInt(localStorage.getItem('userId'), 10);

            // Check if the user is authenticated
            if (!authToken || !userId) {
                alert('You are not signed in. Redirecting to the login page.');
                window.location.href = 'landingpage.html'; // Redirect to login if not authenticated
                return;
            }

            try {
                // Fetch sales data from the API
                const response = await fetch(salesApiUrl, {
                    headers: {
                        Authorization: `Bearer ${authToken}`, // Pass auth token in the request header
                    },
                });

                // Throw an error if the response is not OK
                if (!response.ok) {
                    throw new Error('Failed to fetch sales data.');
                }

                // Parse the response JSON
                const { data } = await response.json();
                // Filter sales data for the current user
                const filteredSales = data.filter(sale => {
                    return sale.users_permissions_users.some(user => user.id === userId);
                });

                // Get references to the HTML elements
                const salesContainer = document.getElementById('salesContainer');
                const totalByItemContainer = document.getElementById('totalByItemContainer');
                let totalSalesAmount = 0;
                const totalByItem = {};

                // Check if there are no sales for the user
                if (filteredSales.length === 0) {
                    salesContainer.innerHTML = '<li class="list-group-item text-center">No sales data available for your account.</li>';
                    return;
                }

                // Loop through each sale and display it
                filteredSales.forEach(sale => {
                    sale.products.forEach(product => {
                        // Create a list item for each product in the sale
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item';

                        // Display product details in the list item
                        listItem.innerHTML = `
                            <div class="row">
                                <div class="col-2"><strong>${product.productName}</strong></div>
                                <div class="col-2">Type: ${product.type}</div>
                                <div class="col-2">Brand: ${product.brand}</div>
                                <div class="col-2">Price: ${product.Price} Php</div>
                                <div class="col-1">Qty Sold: ${sale.quantity}</div>
                                <div class="col-2">Total: ${sale.totalPrice} Php</div>
                                <div class="col-1">Date: ${new Date(sale.createdAt).toLocaleDateString()}</div>
                            </div>
                        `;

                        // Add the list item to the sales container
                        salesContainer.appendChild(listItem);
                        // Add the total price to the overall total sales amount
                        totalSalesAmount += sale.totalPrice;

                        // Calculate totals by item for the summary
                        if (!totalByItem[product.productName]) {
                            totalByItem[product.productName] = { totalQuantity: 0, totalPrice: 0 };
                        }
                        totalByItem[product.productName].totalQuantity += sale.quantity;
                        totalByItem[product.productName].totalPrice += sale.totalPrice;
                    });
                });

                // Generate HTML for the total by item summary
                let totalByItemHTML = '<h3>Total Sales by Item:</h3><ul class="list-group">';
                for (const [productName, totals] of Object.entries(totalByItem)) {
                    totalByItemHTML += `<li class="list-group-item">
                        ${productName} -  
                        Total Quantity Sold: ${totals.totalQuantity} | 
                        Total Price: ${totals.totalPrice.toFixed(2)} Php
                    </li>`;
                }
                totalByItemHTML += '</ul>';
                // Display the total by item summary
                totalByItemContainer.innerHTML = totalByItemHTML;

                // Display the total sales amount
                const totalSalesContainer = document.getElementById('totalSalesContainer');
                totalSalesContainer.innerHTML = `
                    <h3>Total Sales Amount: ${totalSalesAmount.toFixed(2)} Php</h3>
                `;
            } catch (error) {
                // Log and alert if there's an error fetching data
                console.error('Error:', error);
                alert('An error occurred while loading sales data.');
            }
        });
    </script>
</body>
</html>
